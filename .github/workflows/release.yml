# .github/workflows/release.yml

# ----------------------------------------------------------------
# è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ (Automated Release Workflow) - v2 (æ•´åˆç‰ˆ)
# ----------------------------------------------------------------
# è§¦å‘æ—¶æœº: å½“ä¸€ä¸ªæ ¼å¼ä¸º vX.Y.Z çš„æ–°æ ‡ç­¾è¢«æ¨é€åˆ° main æˆ– develop åˆ†æ”¯æ—¶ã€‚
#
# æ ¸å¿ƒåŠŸèƒ½:
# 1. åŸºäº Git æ ‡ç­¾è§¦å‘ï¼ŒåŒºåˆ†é¢„å‘å¸ƒ (develop) å’Œæ­£å¼å‘å¸ƒ (main)ã€‚
# 2. è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥ (Lint) å’Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚
# 3. åŸºäº Conventional Commits è‡ªåŠ¨ç”Ÿæˆæ›´æ–°æ—¥å¿— (Changelog)ã€‚
# 4. åˆ›å»ºåŒ…å«æ›´æ–°æ—¥å¿—å’Œæ„å»ºäº§ç‰©çš„ GitHub Releaseã€‚
# 5. å°†æ‰©å±•å‘å¸ƒåˆ° Open VSX Registry å’Œ Visual Studio Marketplaceã€‚
# 6. å‘é€å‘å¸ƒæˆåŠŸé€šçŸ¥åˆ° Slackã€‚
# ----------------------------------------------------------------

name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  release:
    name: Create and Publish Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.12.1

      - name: Install dependencies
        run: npm ci

      # =================================================================
      # 1. ä»£ç è´¨é‡ä¿è¯ (Code Quality Assurance)
      # =================================================================
      # - name: Lint code
      #   run: pnpm lint

      # - name: Run tests
      #   run: pnpm test

      # =================================================================
      # 2. ç¡®å®šå‘å¸ƒç±»å‹ (Determine Release Type)
      # =================================================================
      - name: Determine if pre-release
        id: determine_prerelease
        run: |
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦åœ¨ develop åˆ†æ”¯ä¸Š
          # git branch --contains <tag> åœ¨ CI ç¯å¢ƒä¸­å¯èƒ½ä¸ç›´æ¥å·¥ä½œ
          # æ›´å¯é çš„æ–¹æ³•æ˜¯æ£€æŸ¥ä¸æ ‡ç­¾å…³è”çš„æäº¤æ˜¯å¦æ˜¯ develop åˆ†æ”¯çš„ä¸€éƒ¨åˆ†
          git fetch --all --tags
          BRANCH_NAME=$(git branch -r --contains ${{ github.ref }} | grep -v 'HEAD' | sed -n 's/origin\///p' | head -n 1)
          echo "Tag ${{ github.ref }} is on branch: $BRANCH_NAME"
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒåˆ†æ”¯
          if [[ "$BRANCH_NAME" == release/* || "$BRANCH_NAME" == "main" ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          fi

      # =================================================================
      # 3. è·å–æ›´æ–°æ—¥å¿— (Generate Changelog)
      # =================================================================
      - name: Extract latest changelog section (ä¸­æ–‡)
        id: extract_changelog
        run: |
          body=$(awk '
            BEGIN { capture=0 }
            /^# [0-9]+\.[0-9]+\.[0-9]+ \(/ {
              if (capture) exit;
              capture=1;
            }
            capture { print }
          ' CHANGELOG.zh-CN.md)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # =================================================================
      # 4. å‘å¸ƒåˆ°å¸‚åœº (Publish to Marketplaces)
      # =================================================================
      - name: Publish to Open VSX Registry
        uses: HaaLeo/publish-vscode-extension@v2
        id: publishToOpenVSX
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}
          preRelease: ${{ steps.determine_prerelease.outputs.is_prerelease }}
          skipDuplicate: true

      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        id: publishToVSMarketplace
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          registryUrl: https://marketplace.visualstudio.com
          extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}
          preRelease: ${{ steps.determine_prerelease.outputs.is_prerelease }}
          skipDuplicate: true

      # =================================================================
      # 5. åˆ›å»º GitHub Release (Create GitHub Release)
      # =================================================================
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.extract_changelog.outputs.body }}
          files: |
            ${{ steps.publishToOpenVSX.outputs.vsixPath }}
          prerelease: ${{ steps.determine_prerelease.outputs.is_prerelease }}
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}

      # =================================================================
      # 6. å‘å¸ƒåé€šçŸ¥ (Post-Release Notification)
      # =================================================================
      - name: Send Slack Notification on Success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸš€ *New Release Published!* ğŸš€\n*Project:* `${{ github.repository }}`\n*Version:* `${{ github.ref_name }}`"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "View the release details here:\n<${{ steps.create_release.outputs.html_url }}|Release ${{ github.ref_name }}>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
