## Context

Dish AI Commit 的代码索引功能通过 tree-sitter 解析代码并使用向量数据库（Qdrant）进行语义索引，为 AI 提供更丰富的上下文信息。当前实现存在以下技术挑战：

1. **全量索引问题**：每次索引都重新处理所有文件，效率低下
2. **资源消耗**：大型项目的索引过程消耗大量 CPU 和内存
3. **用户体验**：缺乏进度反馈和中断机制
4. **数据一致性**：索引中断后无法恢复，需要重新开始

## Goals / Non-Goals

### Goals
- **性能提升**：索引速度提升 60-80%，内存使用减少 40%
- **用户体验**：提供实时进度显示和取消功能
- **可靠性**：支持中断恢复，确保数据一致性
- **可扩展性**：支持大型项目的增量索引

### Non-Goals
- 不改变现有的 tree-sitter 解析逻辑
- 不修改向量数据库的存储格式
- 不改变 AI 提供商的集成方式

## Decisions

### Decision 1: 增量索引策略
**选择**：基于文件修改时间和内容哈希的增量索引
**理由**：
- 文件修改时间可以快速过滤未变更文件
- 内容哈希确保准确检测文件变更
- 相比 Git diff 更简单，不依赖版本控制状态

**替代方案**：
- Git diff 方案：依赖 Git 状态，SVN 支持复杂
- 文件系统监控：实时性好但资源消耗大

### Decision 2: 缓存架构
**选择**：内存 + 磁盘双层缓存架构
**理由**：
- 内存缓存提供快速访问
- 磁盘缓存支持持久化和恢复
- LRU 策略控制内存使用

**替代方案**：
- 纯内存缓存：速度快但易丢失
- 纯磁盘缓存：持久化好但速度慢

### Decision 3: 批量操作策略
**选择**：分批处理，每批 100 个文件
**理由**：
- 平衡内存使用和处理效率
- 支持进度报告和取消操作
- 避免长时间阻塞

**替代方案**：
- 单文件处理：简单但效率低
- 全量处理：效率高但内存消耗大

## Risks / Trade-offs

### Risk 1: 增量索引准确性
**风险**：文件变更检测可能遗漏某些变更
**缓解措施**：
- 使用内容哈希进行二次验证
- 提供手动全量重新索引选项
- 定期进行全量索引验证

### Risk 2: 内存使用增长
**风险**：缓存机制可能增加内存使用
**缓解措施**：
- 实现 LRU 缓存淘汰策略
- 设置内存使用上限
- 监控内存使用情况

### Risk 3: 数据一致性
**风险**：索引中断可能导致数据不一致
**缓解措施**：
- 实现事务机制
- 添加数据完整性检查
- 支持索引状态恢复

## Migration Plan

### 阶段 1: 基础优化（2周）
1. 实现文件变更检测器
2. 优化向量存储批量操作
3. 添加基础缓存机制

### 阶段 2: 用户体验改进（2周）
1. 实现进度显示和取消功能
2. 添加索引状态持久化
3. 更新用户界面

### 阶段 3: 高级功能（2周）
1. 完善监控和诊断功能
2. 添加配置选项
3. 性能优化和测试

### 阶段 4: 验证和部署（1周）
1. 性能测试和验证
2. 文档更新
3. 发布准备

## Open Questions

1. **缓存大小策略**：如何动态调整缓存大小以适应不同项目规模？
2. **并发控制**：是否需要对索引操作进行并发限制？
3. **错误处理**：如何处理向量数据库连接失败的情况？
4. **向后兼容**：如何确保现有索引数据的兼容性？
