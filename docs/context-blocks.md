# ä¸Šä¸‹æ–‡åŒºå—ç´¢å¼•æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† AI æäº¤ä¿¡æ¯ç”Ÿæˆå™¨ä¸­ä½¿ç”¨çš„æ‰€æœ‰ä¸Šä¸‹æ–‡åŒºå—ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„ä½œç”¨ã€ä¼˜å…ˆçº§ã€æˆªæ–­ç­–ç•¥å’Œä½¿ç”¨åœºæ™¯ã€‚

## ğŸ“‹ åŒºå—æ¦‚è§ˆ

| åŒºå—åç§° | ä¼˜å…ˆçº§ | æˆªæ–­ç­–ç•¥ | å¼ºåˆ¶ä¿ç•™ | ä½œç”¨æè¿° |
|---------|--------|----------|----------|----------|
| `code-changes` | 100 | SmartTruncateDiff | âœ… | å½“å‰æäº¤çš„ä»£ç å˜æ›´å†…å®¹ |
| `user-commits` | 950 | TruncateTail | âœ… | ç”¨æˆ·æœ€è¿‘çš„æäº¤å†å² |
| `recent-commits` | 950 | TruncateTail | âœ… | ä»“åº“æœ€è¿‘çš„æäº¤å†å² |
| `reminder` | 900 | TruncateTail | âœ… | ç³»ç»Ÿæé†’å’ŒæŒ‡å¯¼ä¿¡æ¯ |
| `custom-instructions` | 750 | TruncateTail | âŒ | ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤ |
| `original-code` | 800 | SmartTruncateDiff | âŒ | åŸå§‹ä»£ç å†…å®¹ |
| `similar-code` | 320 | TruncateTail | âŒ | ç›¸ä¼¼ä»£ç ä¸Šä¸‹æ–‡ |

## ğŸ” è¯¦ç»†åŒºå—è¯´æ˜

### 1. `code-changes` - ä»£ç å˜æ›´åŒºå—
- **ä¼˜å…ˆçº§**: 100 (æœ€é«˜)
- **æˆªæ–­ç­–ç•¥**: SmartTruncateDiff
- **å¼ºåˆ¶ä¿ç•™**: âœ…
- **ä½œç”¨**: åŒ…å«å½“å‰æäº¤çš„æ‰€æœ‰ä»£ç å˜æ›´å†…å®¹ï¼Œæ˜¯ç”Ÿæˆæäº¤ä¿¡æ¯çš„æ ¸å¿ƒä¾æ®
- **å†…å®¹æ¥æº**: ä» `extractProcessedDiff()` æå–çš„ä»£ç å˜æ›´éƒ¨åˆ†
- **é‡è¦æ€§**: æœ€é«˜ï¼Œè¿™æ˜¯ AI åˆ†æçš„ä¸»è¦å¯¹è±¡

### 2. `user-commits` - ç”¨æˆ·æäº¤å†å²åŒºå—
- **ä¼˜å…ˆçº§**: 950 (é«˜)
- **æˆªæ–­ç­–ç•¥**: TruncateTail
- **å¼ºåˆ¶ä¿ç•™**: âœ…
- **ä½œç”¨**: æä¾›ç”¨æˆ·æœ€è¿‘çš„æäº¤å†å²ï¼Œç”¨äºé£æ ¼å‚è€ƒ
- **å†…å®¹æ¥æº**: `ContextCollector.getRecentCommits()` è·å–çš„ç”¨æˆ·æäº¤è®°å½•
- **è§¦å‘æ¡ä»¶**: ç”¨æˆ·ä¸»åŠ¨å¼€å¯ `useRecentCommitsAsReference` åŠŸèƒ½
- **é‡è¦æ€§**: ç”¨æˆ·ä¸»åŠ¨å¼€å¯ï¼Œå¼ºåˆ¶ä¿ç•™

### 3. `recent-commits` - ä»“åº“æäº¤å†å²åŒºå—
- **ä¼˜å…ˆçº§**: 950 (é«˜)
- **æˆªæ–­ç­–ç•¥**: TruncateTail
- **å¼ºåˆ¶ä¿ç•™**: âœ…
- **ä½œç”¨**: æä¾›ä»“åº“ä¸­å…¶ä»–äººçš„æœ€è¿‘æäº¤ï¼Œç”¨äºé£æ ¼å‚è€ƒ
- **å†…å®¹æ¥æº**: `ContextCollector.getRecentCommits()` è·å–çš„ä»“åº“æäº¤è®°å½•
- **è§¦å‘æ¡ä»¶**: ç”¨æˆ·ä¸»åŠ¨å¼€å¯ `useRecentCommitsAsReference` åŠŸèƒ½
- **é‡è¦æ€§**: ç”¨æˆ·ä¸»åŠ¨å¼€å¯ï¼Œå¼ºåˆ¶ä¿ç•™

### 4. `reminder` - ç³»ç»Ÿæé†’åŒºå—
- **ä¼˜å…ˆçº§**: 900 (é«˜)
- **æˆªæ–­ç­–ç•¥**: TruncateTail
- **å¼ºåˆ¶ä¿ç•™**: âœ…
- **ä½œç”¨**: åŒ…å«ç³»ç»Ÿæé†’ä¿¡æ¯ï¼Œå¦‚è¯­è¨€è¦æ±‚ã€åˆ†ææŒ‡å¯¼ç­‰
- **å†…å®¹æ¥æº**: `ContextCollector.getReminder()` ç”Ÿæˆçš„æé†’ä¿¡æ¯
- **åŒ…å«å†…å®¹**:
  - å¤šæ–‡ä»¶å˜æ›´åˆ†ææŒ‡å¯¼
  - è¯­è¨€è¦æ±‚ï¼ˆå¦‚ "MUST be in Chinese"ï¼‰
  - ä¸è¦å¤åˆ¶å†å²æäº¤çš„æé†’
- **é‡è¦æ€§**: ç³»ç»Ÿæ ¸å¿ƒæŒ‡å¯¼ï¼Œå¼ºåˆ¶ä¿ç•™

### 5. `custom-instructions` - è‡ªå®šä¹‰æŒ‡ä»¤åŒºå—
- **ä¼˜å…ˆçº§**: 750 (ä¸­é«˜)
- **æˆªæ–­ç­–ç•¥**: TruncateTail
- **å¼ºåˆ¶ä¿ç•™**: âŒ
- **ä½œç”¨**: åŒ…å«ç”¨æˆ·æä¾›çš„è‡ªå®šä¹‰æŒ‡ä»¤å’Œè¦æ±‚
- **å†…å®¹æ¥æº**: `ContextCollector.getSCMInputContext()` è·å–çš„ç”¨æˆ·è¾“å…¥
- **æ ¼å¼**: åŒ…è£…åœ¨ `<instructions>` æ ‡ç­¾ä¸­
- **é‡è¦æ€§**: ç”¨æˆ·ç‰¹å®šè¦æ±‚ï¼Œä½†å¯è¢«æˆªæ–­

### 6. `original-code` - åŸå§‹ä»£ç åŒºå—
- **ä¼˜å…ˆçº§**: 800 (é«˜)
- **æˆªæ–­ç­–ç•¥**: SmartTruncateDiff
- **å¼ºåˆ¶ä¿ç•™**: âŒ
- **ä½œç”¨**: æä¾›åŸå§‹ä»£ç å†…å®¹ï¼Œç”¨äºå¯¹æ¯”åˆ†æ
- **å†…å®¹æ¥æº**: ä» `extractProcessedDiff()` æå–çš„åŸå§‹ä»£ç éƒ¨åˆ†
- **å¯æ’é™¤**: å¯é€šè¿‡ `exclude` é€‰é¡¹æ’é™¤
- **é‡è¦æ€§**: æä¾›ä¸Šä¸‹æ–‡ï¼Œä½†å¯è¢«æˆªæ–­æˆ–æ’é™¤

### 7. `similar-code` - ç›¸ä¼¼ä»£ç åŒºå—
- **ä¼˜å…ˆçº§**: 320 (ä½)
- **æˆªæ–­ç­–ç•¥**: TruncateTail
- **å¼ºåˆ¶ä¿ç•™**: âŒ
- **ä½œç”¨**: æä¾›ä¸å½“å‰å˜æ›´ç›¸ä¼¼çš„ä»£ç ä¸Šä¸‹æ–‡
- **å†…å®¹æ¥æº**: `ContextCollector.getSimilarCodeContext()` é€šè¿‡åµŒå…¥æœç´¢è·å–
- **å¯æ’é™¤**: å¯é€šè¿‡ `exclude` é€‰é¡¹æ’é™¤
- **é‡è¦æ€§**: è¾…åŠ©å‚è€ƒï¼Œä¼˜å…ˆçº§æœ€ä½

## ğŸ¯ ä¼˜å…ˆçº§è®¾è®¡ç†å¿µ

### ä¼˜å…ˆçº§åˆ†é…åŸåˆ™
1. **æ ¸å¿ƒåˆ†æå¯¹è±¡** (100): æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¼ºåˆ¶ä¿ç•™ - AI åˆ†æçš„ä¸»è¦ä¾æ®
2. **ç”¨æˆ·ä¸»åŠ¨å¼€å¯çš„åŠŸèƒ½** (950): é«˜ä¼˜å…ˆçº§ï¼Œå¼ºåˆ¶ä¿ç•™ - ç”¨æˆ·æ˜ç¡®è¦æ±‚
3. **ç³»ç»Ÿæ ¸å¿ƒæŒ‡å¯¼** (900): é«˜ä¼˜å…ˆçº§ï¼Œå¼ºåˆ¶ä¿ç•™ - ç³»ç»Ÿé‡è¦ä¿¡æ¯
4. **é‡è¦å‚è€ƒåŒºå—** (800): é«˜ä¼˜å…ˆçº§ï¼Œå¯æˆªæ–­ - æä¾›ä¸Šä¸‹æ–‡
5. **ç”¨æˆ·è‡ªå®šä¹‰å†…å®¹** (750): ä¸­é«˜ä¼˜å…ˆçº§ï¼Œå¯æˆªæ–­ - ç”¨æˆ·ç‰¹å®šè¦æ±‚
6. **è¾…åŠ©å‚è€ƒåŒºå—** (320): ä½ä¼˜å…ˆçº§ï¼Œå¯æˆªæ–­ - è¾…åŠ©ä¿¡æ¯

### å¼ºåˆ¶ä¿ç•™æœºåˆ¶
å¼ºåˆ¶ä¿ç•™çš„åŒºå—åœ¨ç©ºé—´ä¸è¶³æ—¶ï¼š
- ä¸ä¼šè¢«å®Œå…¨ç§»é™¤
- ä¼šå°è¯•æˆªæ–­è€Œä¸æ˜¯åˆ é™¤
- åªæœ‰ `code-changes` åœ¨æç«¯æƒ…å†µä¸‹æ‰ä¼šè¢«æˆªæ–­

## ğŸ”„ æˆªæ–­ç­–ç•¥è¯´æ˜

### TruncateTail
- **é€‚ç”¨åŒºå—**: æ–‡æœ¬ç±»å†…å®¹
- **ç­–ç•¥**: ä»å°¾éƒ¨æˆªæ–­ï¼Œä¿ç•™å¼€å¤´éƒ¨åˆ†
- **ä½¿ç”¨åœºæ™¯**: æäº¤å†å²ã€æé†’ä¿¡æ¯ã€è‡ªå®šä¹‰æŒ‡ä»¤ç­‰

### SmartTruncateDiff
- **é€‚ç”¨åŒºå—**: ä»£ç å˜æ›´å†…å®¹
- **ç­–ç•¥**: æ™ºèƒ½æˆªæ–­ï¼Œä¼˜å…ˆä¿ç•™æ–‡ä»¶å¤´å’Œé‡è¦å˜æ›´
- **ä½¿ç”¨åœºæ™¯**: ä»£ç å˜æ›´ã€åŸå§‹ä»£ç ç­‰

## ğŸ“Š åŒºå—å¤„ç†æµç¨‹

```mermaid
graph TD
    A[æ”¶é›†æ‰€æœ‰åŒºå—] --> B[æŒ‰ä¼˜å…ˆçº§æ’åº]
    B --> C[åˆ†ç¦»å¼ºåˆ¶ä¿ç•™åŒºå—]
    C --> D[å¤„ç†å¼ºåˆ¶ä¿ç•™åŒºå—]
    D --> E[å¤„ç†å¯å¤„ç†åŒºå—]
    E --> F[æŒ‰æœ€ç»ˆé¡ºåºæ’åº]
    F --> G[æ„å»ºæœ€ç»ˆå†…å®¹]
    
    D --> D1{ç©ºé—´è¶³å¤Ÿ?}
    D1 -->|æ˜¯| D2[å®Œæ•´ä¿ç•™]
    D1 -->|å¦| D3[å°è¯•æˆªæ–­]
    
    E --> E1{ç©ºé—´è¶³å¤Ÿ?}
    E1 -->|æ˜¯| E2[å®Œæ•´ä¿ç•™]
    E1 -->|å¦| E3[æˆªæ–­æˆ–ç§»é™¤]
```

## ğŸ› ï¸ é…ç½®é€‰é¡¹

### æ’é™¤é€‰é¡¹
å¯ä»¥é€šè¿‡ `exclude` å‚æ•°æ’é™¤ç‰¹å®šåŒºå—ï¼š
```typescript
const options = {
  exclude: ["similar-code", "original-code"]
};
```

### å¼ºåˆ¶ä¿ç•™é…ç½®
åœ¨ `constants.ts` ä¸­é…ç½®å¼ºåˆ¶ä¿ç•™çš„åŒºå—ï¼š
```typescript
export const FORCE_RETAIN_BLOCKS: string[] = [
  "code-changes",
  "user-commits",
  "recent-commits", 
  "reminder"
];
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```typescript
const contextBuilder = new CommitContextBuilder();
const contextManager = await contextBuilder.buildContextManager(
  selectedModel,
  systemPrompt,
  scmProvider,
  diffContent,
  configuration
);
```

### æ’é™¤ç‰¹å®šåŒºå—
```typescript
const contextManager = await contextBuilder.buildContextManager(
  selectedModel,
  systemPrompt,
  scmProvider,
  diffContent,
  configuration,
  { exclude: ["similar-code"] }
);
```

## ğŸ”§ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°åŒºå—
1. åœ¨ `ContextCollector` ä¸­æ·»åŠ æ”¶é›†æ–¹æ³•
2. åœ¨ `CommitContextBuilder` ä¸­æ·»åŠ åŒºå—
3. åœ¨ `FINAL_BLOCK_ORDER` ä¸­å®šä¹‰æ’åºä½ç½®
4. æ ¹æ®éœ€è¦æ·»åŠ åˆ° `FORCE_RETAIN_BLOCKS`

### ä¿®æ”¹ä¼˜å…ˆçº§
åœ¨ `CommitContextBuilder` ä¸­è°ƒæ•´ `priority` å€¼ï¼š
- æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
- å»ºè®®ä½¿ç”¨ 100 çš„å€æ•°ä¾¿äºç®¡ç†

### è‡ªå®šä¹‰æˆªæ–­ç­–ç•¥
åœ¨ `TruncationStrategy` æšä¸¾ä¸­æ·»åŠ æ–°ç­–ç•¥ï¼Œå¹¶åœ¨ `ContentTruncator` ä¸­å®ç°ã€‚

---

*æœ€åæ›´æ–°: 2024å¹´12æœˆ*
